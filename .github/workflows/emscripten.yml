name: CI Tests

on:
#  push:
#    branches: [ develop ]
  pull_request:
    branches: [ develop ]

jobs:
  build_emscripten:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Fetch Docker Image
        run: |
          export EMSDK_VERSION=$(grep "emscripten/emsdk" scripts/docker/buildpack-deps/Dockerfile.emscripten | cut -f 2 -d ' ' | cut -f 2 -d ':')
          export VERSION=$(grep "LABEL version=" scripts/docker/buildpack-deps/Dockerfile.emscripten  | cut -d '"' -f 2)
          echo ${GITHUB_TOKEN} | docker login -u ${GITHUB_ACTOR} --password-stdin docker.pkg.github.com
          docker pull docker.pkg.github.com/ekpyron/solidity/solidity-buildpack-deps:emsdk-${EMSDK_VERSION}-${VERSION}
          docker tag docker.pkg.github.com/ekpyron/solidity/solidity-buildpack-deps:emsdk-${EMSDK_VERSION}-${VERSION} emsdk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Build
        run: |
          docker run -v `pwd`:/root/project -w /root/project emsdk ./scripts/travis-emscripten/build_emscripten.sh
      - name: Store Version
        run: |
                scripts/get_version.sh
                echo "Version: $(scripts/get_version.sh)"
                echo "::set-output name=version::$(scripts/get_version.sh)"
      - name: Store Artifacts
        uses: actions/upload-artifact@v1
        with:
          name: soljson
          path: upload/
  test_emscripten:
    needs: build_emscripten
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
        with:
          path: 'solidity'
      - name: Debug Output
        run: |
          echo ${{ needs.build_emscripten.outputs.version }}
          echo "Version: ${{ needs.build_emscripten.outputs.version }}"
          echo 'Version: ${{ needs.build_emscripten.outputs.version }}'
      - uses: actions/checkout@v2
        with:
          repository: 'ethereum/solc-js'
          ref: v${{ needs.build_emscripten.outputs.version }}
          path: 'solc-js'
      - name: Download Artifacts
        uses: actions/download-artifact@v1
        with:
          name: soljson
          path: upload
      - name: Use Node.js
        uses: actions/setup-node@v1
      - name: Run solc-js tests.
        run: solidity/test/externalTests/solc-js/solc-js.sh upload/soljson.js ${{ needs.build_emscripten.outputs.version }}
  publish_emscripten:
    needs: build_emscripten
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
      - name: Download Artifacts
        uses: actions/download-artifact@v1
        with:
          name: soljson
          path: upload
      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v0.42.0
          release_name: Release v0.42.0
#          tag_name: ${{ github.ref }}
#          release_name: Release ${{ github.ref }}
          body: |
            Release Announcement Template.
            Maybe even Changelog.
          draft: true
          prerelease: false
      - name: Upload soljson.js
        id: upload-soljson-js 
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./upload/soljson.js
          asset_name: soljson.js
          asset_content_type: text/javascript
